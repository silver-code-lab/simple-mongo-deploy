name: Deploy to EC2 (docker-compose)

on:
  push:
    branches: [ "main" ]
    paths:
      - "docker-compose.prod.yml"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Write SSH private key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Copy compose file to server
        run: |
          scp -o StrictHostKeyChecking=no -i key.pem docker-compose.prod.yml \
            ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/docker-compose.prod.yml

      - name: Install Docker on EC2 (official Docker repo – idempotent)
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.EC2_HOST }} <<'EOF'
            set -eux
            export DEBIAN_FRONTEND=noninteractive

            # אם לדוקר+קומפוז יש גרסה — דלג על התקנה
            if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
              docker --version
              docker compose version
              exit 0
            fi

            # נקה רשימת מקורות שבורה אם קיימת
            sudo rm -f /etc/apt/sources.list.d/docker.list || true

            sudo apt-get update -y || true
            sudo apt-get remove -y docker docker-engine docker.io containerd runc docker-compose || true
            sudo rm -f /usr/local/bin/docker-compose /usr/bin/docker-compose || true

            sudo apt-get install -y ca-certificates curl gnupg lsb-release

            # מפתח GPG (batch mode כדי שלא יבקש TTY)
            sudo install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
              | sudo gpg --batch --yes --dearmor -o /etc/apt/keyrings/docker.gpg
            sudo chmod a+r /etc/apt/keyrings/docker.gpg

            ARCH=$(dpkg --print-architecture)
            CODENAME=$( . /etc/os-release && echo "$VERSION_CODENAME" )
            echo "deb [arch=${ARCH} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu ${CODENAME} stable" \
              | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

            sudo apt-get update -y
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

            sudo systemctl enable --now docker || true
            sudo usermod -aG docker ubuntu || true

            docker --version
            docker compose version
          EOF

      - name: Remote deploy
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.EC2_HOST }} <<'EOF'
            set -eux
            cd /home/ubuntu

            if [ -n "${DOCKERHUB_USERNAME:-}" ] && [ -n "${DOCKERHUB_TOKEN:-}" ]; then
              echo "${DOCKERHUB_TOKEN}" | sudo docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
            fi

            sudo docker compose -f docker-compose.prod.yml pull
            sudo docker compose -f docker-compose.prod.yml up -d
            sudo docker compose -f docker-compose.prod.yml ps
            curl -sf http://127.0.0.1:8000/health || true
          EOF
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
